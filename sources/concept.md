ТЕХНИЧЕСКОЕ ЗАДАНИЕ: 2D Стратегия «Monolith War» 1. МЕТА-ИНФОРМАЦИЯ ПРОЕКТА 1.1 Целевая платформа и Стек Тип: Браузерная многопользовательская стратегия (IO-game) в реальном времени. Лицензия: GPLv3. Исполнитель: Только AI-агент GPT-5.1-Codex-Max (в среде OpenAI Codex). Людьми не будет писаться ни одной строчки кода. Метод разработки: Итеративный (функция за функцией). Приоритет архитектуры: Читаемость кода, строгая типизация, минимизация когнитивной нагрузки на агента. Производительность вторична по отношению к стабильности логики. 1.3 Инфраструктура Сервер: 1 VPS (Восточная Европа), бюджет ~7000₽/мес. Масштабирование: Вертикальное (один процесс Node.js). Лимиты: Максимум 2 активных лобби одновременно. 2. ИГРОВОЙ МИР И МАТЕМАТИКА 2.1 Система Координат и Сетка Размер карты: 400 × 240 клеток. Размер клетки (Cell): 32 × 32 пикселя. Чанки (Chunks): Карта разбита на сегменты 16 × 16 клеток. Всего чанков: 25 по горизонтали × 15 по вертикали (Итого 375 чанков). Центрирование: Координата (0,0) — левый верхний угол. 2.2 Монолиты (Центры чанков) Расположение: В геометрическом центре каждого чанка находится структура размером 2×2 клетки. Свойства: Клетки под Монолитом являются «мёртвой зоной» (Void). Они не могут быть окрашены, не приносят доход и не идут в зачёт территории. Итого активных клеток в чанке: 256−4=252. Параметры Монолита: Владелецем становиться игрок, окрасивший >200 клеток в данном чанке. И он владелец до тех пор, пока другой игрок не окрасит >200 клеток в этом чанке. После того как монолит был кем-то захвачен, он больше никогда не станет нейтральным, а будет только перезахватываться. Тир (Уровень): Число от 1 до N. Отображается текстом на Монолите. Функция: Определяет доходность всех клеток в своём чанке (см. раздел Экономика). 2.3 Время и Тики (Tick Rate) Server Tick Rate: 15 тиков в секунду (66.66 мс/тик). Client FPS: 30 кадров в секунду (интерполяция позиций между тиками сервера). Логика: Весь геймплей (движение, урон, экономика) дискретен и привязан к тикам. 3. СЕТЕВОЙ ПРОТОКОЛ И ЛОББИ 3.1 Жизненный цикл Лобби Инициализация: Создается Лобби №1. Игра начинается автоматически, как только набралось 4 игрока. Late Join (Поздний вход): Новые игроки могут присоединяться к идущей игре, пока на карте суммарно захвачено (окрашено в цвет любого игрока) менее 200 Монолитов. Если Лобби №1 заблокировано для входа (все монолиты заняты или лимит игроков), создается Лобби №2. Балансировка: Новый игрок направляется в лобби с наибольшим количеством незахваченных Монолитов. Если оба лобби заполнены/заблокированы: Клиент получает сообщение «Ожидание нового лобби». Лимит игроков в одном лобби: Не ограничен жестким числом, ограничен наличием свободных Монолитов для спавна. 3.2 Процедура Входа (Login) Никнейм: Поле ввода (макс. 20 символов). Если пусто: Ник генерируется как Kingdom + Random(10-99). Спавн (Алгоритм): Территория игрока спавниться в центре чанка (вокруг Монолита). Начальная территория игрока, это квадрат 10 на 10 с монолитом в центре. Выбор чанка: Спиральный поиск от центра карты к краям. Выбирается ближайший к центру чанк, где Монолит еще никому не принадлежит и в нем нет другого игрока. Строительство первой казармы для всех игроков бесплатно. Начальный лимит юнитов 10. Каждый саплай даёт +1 лимит. Можно строить саплаи сверх лимита, но суммарно лимит у игрока вы 64 не поднимаеться. Бонус новичка: Стартовый баланс краски = (Доход ТОП-1 игрока в лобби * 100). 3.3 Принципы Синхронизации Server Authority: Клиент шлёт только намерения (Move, Build). Сервер валидирует и возвращает состояние. Rate Limiting: Сервер игнорирует команды, приходящие чаще, чем позволяет физика игры (анти-спам). Если игрок заново зашёл, в лобби, после того как его покинул (выключился интернет на время), то его рекконектит за его же территорию. Если у него не осталось ни одного здания и меньше 500 клеток, то его спавнит как нового игрока. 4. ИГРОВАЯ МЕХАНИКА (СЕРВЕР) 4.1 Экономика (Расчет 1 раз в секунду) Валюта: Краска. Лимит: Лимит юнитов (Supply). Формула дохода: Income= chunk∈Map∑(OwnedCells chunk ×MonolithTier chunk) Пояснение: Каждая окрашенная клетка приносит доход, равный Тиру Монолита, находящегося в том же чанке, что и клетка. (Независимо от того, кто владеет самим Монолитом). Отображение: Игроку показывается число с не более, чем 5 цифрами. После числа дописывается k, m, b, t или ничего если краски <100000. 4.2 Туман Войны (Fog of War) Тип: Чанковый (Chunk-based). Видимость: Игрок видит контент (юнитов, здания, изменения тайлов) только в: Чанках, где у него есть хотя бы 1 окрашенная клетка. Всех 8 соседних чанках к вышеописанным. Реализация: Сервер не отправляет данные об объектах из "туманных" чанков клиенту (экономия трафика и анти-чит). 4.3 Юниты и Движение Максимум юнитов: 64 на игрока. Коллизии: Юнит занимает 1 клетку. Здания занимают 2×2 клетки. Юниты не могут проходить сквозь здания и друг друга. Логика скорости (в тиках): ticksPerTile — базовое кол-во тиков на преодоление 1 клетки. Шаг по диагонали: round(ticksPerTile * 1.4). Fast Mode: Если юнит не атаковал и не красил (и не был атакован) последние 5 секунд (75 тиков), он ускоряется. fastTicksPerTile = max(1, floor(ticksPerTile / 4)). Юниты расталкивают друг друга и скользят вдоль препятствий. 4.4 Боевая система Модель: Auto-attack при входе врага в радиус. Урон: мгновенный. Снарядов нет, вместо этого линия между атакующим и атакуемым. Линия затухает за 10 тиков. Целеуказание: Ближайший враг. Смена цели только при смерти текущей или выходе из радиуса. 4.5 Закрашивание (Painting) Условие: Юнит красит территорию, если он НЕ в кулдауне (не атаковал/не получал урон последние 75 тиков). Механика: Мгновенное перекрашивание клеток под юнитом и вокруг него. Радиус кисти: 0 = только 1 клетка под юнитом. 1 = квадрат 3×3. 2 = квадрат 5×5. Стоимость: 15 краски за 1 клетку. Списывается автоматически. Если краски нет — не красит. Каждая клетка не может быть перекрашена, чаще, чем раз в 15 тиков. То есть после перекрашивания, она не доступна для нового перекрашивания в течение 15 тиков. 4.6 Строительство и Улучшение Монолитов Здания: Казарма, Башня, Саплай (Увеличивает лимит). Размер: 2×2. Условие: Можно строить только на своей территории (окрашенных клетках). Ограничение: Нельзя красить клетки под зданиями врага, пока здание не уничтожено. Улучшение Монолита: Доступно игроку, контролирующему Монолит (>200 клеток в чанке). UI: При наведении на Монолит или соседние клетки отображается цена апгрейда. Стоимость: 12000+(CurrentTier−1)×2000 12000+(CurrentTier−1)×2000. Эффект: Увеличивает множитель дохода для всех клеток в этом чанке. В том числе и доход от вражеских клеток врагам. 5. ПОБЕДА И UI 5.1 Условие Победы (King of the Hill) Триггер: Игрок контролирует > 40 000 клеток. Событие: Вся территория этого игрока становится видна всем на карте (сквозь туман войны). Глобальное оповещение всем: "Игрок X близок к победе! Осталось 5 минут". Личное оповещение игроку: "Удерживайте >40k клеток 5 минут для победы". Оповещение пропадает автоматически через 10 секунд. Так же его можно закрыть по крестику на нём. Таймер: Запускается обратный отсчёт 5 минут (300 секунд). Если контроль падает < 40 000, таймер сбрасывается пропадает. Финал: При истечении таймера — победа. Всем пишет ник победителя, и через 4 секунды, выбрасывает на главный экран. 5.2 Интерфейс (HUD) Top-Left: Leaderboard (Локальный для сессии): Топ-5 (Ник, Контролируемые клетки). Обновление раз в 2 сек. Баланс краски (+ прирост/сек). Лимит юнитов (Занято/Всего). Left-Vertical: Иконки построек (Казарма, Башня, Саплай). Hotkeys на иконках. Toggle-кнопка: "Авто-покраска" (Вкл/Выкл) + Hotkey. Управление: ЛКМ: Выделение юнитов (рамка), выбор здания. ПКМ: Движение/Атака. WASD: Камера. Scroll: Зум. 6. СУЩНОСТИ И БАЛАНС (JSON Config) Конфигурация должна быть вынесена в JSON. 6.1 Юниты Параметры: Cost, HP, Damage, AttackRange, TicksPerTile (Speed), PaintRadius. Все юниты дальнобойные. 6.2 Здания Казарма: Производит юнитов (мгновенно). Башня: Стационарная турель. Саплай: Дает лимит юнитов. Монолит (Нейтральный/Захваченный): Неуязвим, нельзя снести.